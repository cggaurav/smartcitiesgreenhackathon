<script src="/socket.io/socket.io.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/d3/3.5.15/d3.js" type="text/javascript" charset="utf-8"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.0.0-beta1/jquery.min.js" type="text/javascript" charset="utf-8"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/epoch/0.8.4/js/epoch.min.js" type="text/javascript" charset="utf-8"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/1.4.5/socket.io.min.js" type="text/javascript" charset="utf-8"></script>
<link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/epoch/0.8.4/css/epoch.min.css">
<body>
  <div class="epoch-theme-dark">
    <div id="areaChart" style="width: 100%; height: 500px" class="epoch-theme-dark category20 epoch">
    </div>
  </div>
  <script>
    var socket = io();

    var nextsample = 0;
    var lastsample = 0;

    socket.on('update', function(msg) {
      var T = (new Date()).getTime() / 1000;
      if (T <= nextsample) {
        return;
      }
      lastsample = T;
      nextsample = T + 1.0;
      msg = JSON.parse(msg);
      console.log('UPDATE', msg);
      chart.push([{
        time: T,
        y: msg.ppm / 20
      }]);
    });

    var chart = $('#areaChart').epoch({
      type: 'time.area',
      axes: ['bottom', 'left'],
      data: [{
        label: "Air sensor",
        values: [ {time: (new Date()).getTime()/1000, y: 10}]
      }]
    });

    setInterval(function() {
      var T = (new Date()).getTime() / 1000;
      if ((T - lastsample) > 2.0) {
        console.log('pushing to chart');
        chart.push([{time: (new Date()).getTime()/1000, y: Math.random()*100}]);
      }
    }, 100);
  </script>
</body>
